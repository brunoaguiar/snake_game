<!DOCTYPE html">
<html>

<head>
    <meta charset="UTF-8">
    <title>Snake Game</title>
    <link rel="stylesheet" href="main.css">
</head>

<body>

    <span id="score"></span>
    <canvas id="game_canvas" width="800" height="800"></canvas>

    <script>
        let num_tiles = 40;

        let snake = {
            position: {
                x: 10,
                y: 10
            },
            velocity: {
                x: 1,
                y: 0
            },
            trail: [],
            size: 1
        }

        let apple_pos;

        window.onload = () => {
            canvas = document.getElementById("game_canvas");
            messageSpan = document.getElementById("score");
            context = canvas.getContext("2d");


            document.addEventListener("keydown", keyPush);
            setInterval(game_loop, 1000 / 15)


            tile_length = canvas.width / num_tiles;
            reset();

        }

        function reset() {

            snake = {
                position: {
                    x: 10,
                    y: 10
                },
                velocity: {
                    x: 1,
                    y: 0
                },
                trail: [],
                size: 1
            }
            generateApplePosition();
            setMessage("Welcome to the snake game!")
        }

        function game_loop() {

            updateSnakePosition();

            paintBackground();
            drawSnake();
            drawApple();
        }

        function updateSnakePosition() {
            //update snake position
            snake.position.x += snake.velocity.x;
            snake.position.y += snake.velocity.y;

            if (snake.position.x < 0) {
                snake.position.x = num_tiles - 1;
            }
            if (snake.position.y < 0) {
                snake.position.y = num_tiles - 1;
            }
            if (snake.position.y > num_tiles - 1) {
                snake.position.y = 0;
            }
            if (snake.position.x > num_tiles - 1) {
                snake.position.x = 0;
            }

            //check new position
            snake.trail.forEach(pos => {

                //check if lost
                if (snake.position.x == pos.x
                    && snake.position.y == pos.y) {
                    alert("You lost. You score score was " + snake.size)
                    reset();
                }

                //check if ate apple
                if (snake.position.x == apple_pos.x
                    && snake.position.y == apple_pos.y) {
                    snake.size++;
                    setMessage("Score is " + snake.size);
                    generateApplePosition();
                }
            });

            //save position history
            snake.trail.push(Object.assign({}, snake.position));
            while (snake.trail.length > snake.size) {
                snake.trail.shift();
            }
        }

        function setMessage(message) {
            messageSpan.innerHTML = message
        }

        function drawSnake() {
            context.fillStyle = "lime"
            snake.trail.forEach(pos => {
                context.fillRect(pos.x * tile_length, pos.y * tile_length, tile_length - 2, tile_length - 2)
            })
        }

        function paintBackground() {
            context.fillStyle = "black";
            context.fillRect(0, 0, canvas.width, canvas.height)
        }

        function drawApple() {
            context.fillStyle = "red"
            context.fillRect(apple_pos.x * tile_length, apple_pos.y * tile_length, tile_length, tile_length)
        }

        function generateApplePosition() {
            apple_pos = {
                x: Math.floor(Math.random() * num_tiles),
                y: Math.floor(Math.random() * num_tiles)
            }

            console.log("Generated apple in: " + apple_pos.x + "-" + apple_pos.y)
        }

        function keyPush(evt) {
            switch (evt.keyCode) {
                case 37:
                    snake.velocity.x = -1;
                    snake.velocity.y = 0;
                    break;
                case 38:
                    snake.velocity.x = 0;
                    snake.velocity.y = -1;
                    break;
                case 39:
                    snake.velocity.x = 1;
                    snake.velocity.y = 0;
                    break;
                case 40:
                    snake.velocity.x = 0;
                    snake.velocity.y = 1;
                    break;
            }
        }

    </script>

</body>

</html>